<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="EduBrain AI - 智能题库系统，支持外部题库与AI双重保障"
        />
        <meta name="keywords" content="AI, 题库, 智能问答, 教育, 人工智能" />
        <title>EduBrain AI - 智能题库系统</title>
        <link rel="stylesheet" href="/static/style.css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div class="container">
            <header class="header">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                    <h1>EduBrain AI</h1>
                </div>
                <p class="subtitle">智能题库系统 - 支持外部题库与AI双重保障</p>
                <div class="integration-notice">
                    <i class="fas fa-info-circle"></i>
                    <span
                        >可集成到OCS网课助手使用 -
                        <a href="/docs" class="notice-link"
                            >查看集成指南</a
                        ></span
                    >
                </div>
            </header>

            <main class="main-content">
                <div class="search-card">
                    <div class="card-header">
                        <i class="fas fa-search"></i>
                        <h2>智能问答</h2>
                    </div>

                    <div class="feature-notice">
                        <i class="fas fa-lightbulb"></i>
                        <div class="notice-content">
                            <strong>提示：</strong> 支持外部题库查询，可在
                            <code>external_databases.json</code>
                            中配置更多题库源
                        </div>
                    </div>

                    <form id="searchForm" class="search-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="title">
                                    <i class="fas fa-question-circle"></i>
                                    题目内容
                                </label>
                                <textarea
                                    id="title"
                                    name="title"
                                    required
                                    placeholder="请输入题目内容..."
                                    rows="3"
                                    maxlength="1000"
                                ></textarea>
                                <div class="character-counter">
                                    <span id="titleCounter">0</span>/1000
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="type">
                                    <i class="fas fa-list"></i>
                                    题型
                                </label>
                                <select id="type" name="type">
                                    <option value="single">单选题</option>
                                    <option value="multiple">多选题</option>
                                    <option value="judgement">判断题</option>
                                    <option value="completion">填空题</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="options">
                                    <i class="fas fa-tasks"></i>
                                    选项内容
                                </label>
                                <textarea
                                    id="options"
                                    name="options"
                                    placeholder="请输入选项内容（可选）"
                                    rows="3"
                                    maxlength="500"
                                ></textarea>
                                <div class="character-counter">
                                    <span id="optionsCounter">0</span>/500
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="context">
                                    <i class="fas fa-file-alt"></i>
                                    上下文信息
                                </label>
                                <textarea
                                    id="context"
                                    name="context"
                                    placeholder="请输入上下文信息（可选）"
                                    rows="2"
                                    maxlength="300"
                                ></textarea>
                                <div class="character-counter">
                                    <span id="contextCounter">0</span>/300
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            <span>搜索答案</span>
                        </button>
                    </form>
                </div>

                <div id="result" class="result-card" style="display: none">
                    <div class="card-header">
                        <i class="fas fa-check-circle"></i>
                        <h3>搜索结果</h3>
                    </div>
                    <div id="resultContent" class="result-content"></div>
                </div>

                <div id="loading" class="loading-card" style="display: none">
                    <div class="loading-spinner">
                        <i class="fas fa-brain"></i>
                        <p>
                            正在智能分析中<span class="loading-dots"
                                ><span></span><span></span><span></span
                            ></span>
                        </p>
                    </div>
                </div>
            </main>

            <footer class="footer">
                <div class="footer-links">
                    <a href="/dashboard" class="footer-link">
                        <i class="fas fa-tachometer-alt"></i>
                        管理面板
                    </a>
                    <a href="/docs" class="footer-link">
                        <i class="fas fa-book"></i>
                        API文档
                    </a>
                </div>
                <p class="footer-text">© 2025 EduBrain AI - 智能题库系统</p>
            </footer>
        </div>

        <script>
            // 字符计数器功能
            function updateCounter(textareaId, counterId, maxLength) {
                const textarea = document.getElementById(textareaId);
                const counter = document.getElementById(counterId);
                const counterElement = counter.parentElement;

                textarea.addEventListener("input", function () {
                    const count = this.value.length;
                    counter.textContent = count;

                    // 移除所有状态类
                    counterElement.classList.remove("warning", "error");

                    // 添加适当的状态类
                    if (count > maxLength * 0.9) {
                        counterElement.classList.add("error");
                    } else if (count > maxLength * 0.7) {
                        counterElement.classList.add("warning");
                    }
                });
            }

            // 初始化字符计数器
            updateCounter("title", "titleCounter", 1000);
            updateCounter("options", "optionsCounter", 500);
            updateCounter("context", "contextCounter", 300);

            document
                .getElementById("searchForm")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const data = Object.fromEntries(formData);

                    // 显示加载状态
                    document.getElementById("loading").style.display = "block";
                    document.getElementById("result").style.display = "none";

                    // 添加按钮加载状态
                    const submitBtn = this.querySelector(".btn-primary");
                    submitBtn.disabled = true;
                    submitBtn.innerHTML =
                        '<i class="fas fa-spinner fa-spin"></i><span>搜索中...</span>';

                    try {
                        const response = await fetch("/api/search", {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/x-www-form-urlencoded",
                            },
                            body: new URLSearchParams(data),
                        });

                        const result = await response.json();
                        const resultDiv = document.getElementById("result");
                        const resultContent =
                            document.getElementById("resultContent");

                        if (result.code === 1) {
                            resultContent.innerHTML = `
                        <div class="success-result">
                            <div class="result-item">
                                <strong>题目：</strong>
                                <span>${result.question}</span>
                            </div>
                            <div class="result-item">
                                <strong>答案：</strong>
                                <span class="answer-highlight">${
                                    result.answer
                                }</span>
                            </div>
                            <div class="result-meta">
                                <small><i class="fas fa-clock"></i> 处理时间: ${
                                    result.processing_time || "N/A"
                                }</small>
                            </div>
                        </div>
                    `;
                            resultDiv.className = "result-card success";
                        } else {
                            resultContent.innerHTML = `
                        <div class="error-result">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>${result.msg}</p>
                        </div>
                    `;
                            resultDiv.className = "result-card error";
                        }

                        resultDiv.style.display = "block";
                    } catch (error) {
                        console.error("Error:", error);
                        const resultDiv = document.getElementById("result");
                        const resultContent =
                            document.getElementById("resultContent");
                        resultContent.innerHTML = `
                    <div class="error-result">
                        <i class="fas fa-times-circle"></i>
                        <p>网络错误，请检查连接后重试</p>
                    </div>
                `;
                        resultDiv.className = "result-card error";
                        resultDiv.style.display = "block";
                    } finally {
                        document.getElementById("loading").style.display =
                            "none";
                        // 恢复按钮状态
                        submitBtn.disabled = false;
                        submitBtn.innerHTML =
                            '<i class="fas fa-search"></i><span>搜索答案</span>';
                    }
                });
        </script>
    </body>
</html>
