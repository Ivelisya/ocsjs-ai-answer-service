<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="EduBrain AI 管理面板 - 系统状态监控与管理"
        />
        <meta name="keywords" content="管理面板, 系统监控, 缓存管理, AI系统" />
        <title>管理面板 - EduBrain AI</title>
        <link rel="stylesheet" href="/static/style.css" />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div class="container">
            <header class="header">
                <div class="logo">
                    <i class="fas fa-tachometer-alt"></i>
                    <h1>管理面板</h1>
                </div>
                <p class="subtitle">系统状态监控与管理</p>
            </header>

            <main class="main-content">
                <div class="stats-card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h2>系统状态</h2>
                    </div>

                    <div class="config-hint">
                        <i class="fas fa-cog"></i>
                        <div class="hint-content">
                            <strong>配置提示：</strong> 可在
                            <code>config.py</code> 中修改AI提供商设置，在
                            <code>external_databases.json</code> 中添加外部题库
                        </div>
                    </div>

                    <div id="statsContent" class="stats-content">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>正在加载统计信息...</p>
                        </div>
                    </div>
                </div>

                <div class="cache-card">
                    <div class="card-header">
                        <i class="fas fa-database"></i>
                        <h2>缓存管理</h2>
                    </div>
                    <div class="cache-content">
                        <p class="cache-description">
                            清除系统缓存可以释放内存并确保获取最新数据。
                        </p>
                        <button id="clearCacheBtn" class="btn btn-secondary">
                            <i class="fas fa-trash"></i>
                            <span>清除缓存</span>
                        </button>
                        <div
                            id="cacheResult"
                            class="result-message"
                            style="display: none"
                        ></div>
                    </div>
                </div>

                <div class="qa-records-card">
                    <div class="card-header">
                        <i class="fas fa-history"></i>
                        <h2>问答记录</h2>
                    </div>
                    <div class="qa-records-content">
                        <div id="qaRecordsContent" class="qa-records-list">
                            <div class="loading-spinner">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>正在加载问答记录...</p>
                            </div>
                        </div>
                        <div class="qa-records-controls">
                            <div class="qa-records-actions">
                                <button
                                    id="refreshRecordsBtn"
                                    class="btn btn-secondary"
                                >
                                    <i class="fas fa-sync"></i>
                                    <span>刷新记录</span>
                                </button>
                                <button
                                    id="clearRecordsBtn"
                                    class="btn btn-danger"
                                >
                                    <i class="fas fa-trash-alt"></i>
                                    <span>清除记录</span>
                                </button>
                            </div>
                            <div class="pagination-controls">
                                <button
                                    id="prevPageBtn"
                                    class="btn btn-secondary"
                                    disabled
                                >
                                    <i class="fas fa-chevron-left"></i>
                                    <span>上一页</span>
                                </button>
                                <span id="pageInfo" class="page-info"
                                    >第 1 页</span
                                >
                                <button
                                    id="nextPageBtn"
                                    class="btn btn-secondary"
                                    disabled
                                >
                                    <i class="fas fa-chevron-right"></i>
                                    <span>下一页</span>
                                </button>
                            </div>
                            <div
                                id="clearRecordsResult"
                                class="result-message"
                                style="display: none"
                            ></div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="footer">
                <div class="footer-links">
                    <a href="/" class="footer-link">
                        <i class="fas fa-home"></i>
                        首页
                    </a>
                    <a href="/docs" class="footer-link">
                        <i class="fas fa-book"></i>
                        API文档
                    </a>
                </div>
                <p class="footer-text">© 2024 EduBrain AI - 智能题库系统</p>
            </footer>
        </div>

        <script>
            // 加载统计信息
            async function loadStats() {
                try {
                    const response = await fetch("/api/stats");
                    const stats = await response.json();
                    const statsDiv = document.getElementById("statsContent");

                    statsDiv.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-code-branch"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.version
                                    }</div>
                                    <div class="stat-label">版本</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${Math.floor(
                                        stats.uptime / 3600
                                    )}h ${Math.floor(
                        (stats.uptime % 3600) / 60
                    )}m</div>
                                    <div class="stat-label">运行时间</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.ai_provider
                                    }</div>
                                    <div class="stat-label">AI提供商</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${stats.model}</div>
                                    <div class="stat-label">模型</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-memory"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.cache_enabled ? "启用" : "禁用"
                                    }</div>
                                    <div class="stat-label">缓存状态</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.cache_size
                                    }</div>
                                    <div class="stat-label">缓存大小</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.qa_records_count
                                    }</div>
                                    <div class="stat-label">问答记录</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-external-link-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">${
                                        stats.external_database_enabled
                                            ? "启用"
                                            : "禁用"
                                    }</div>
                                    <div class="stat-label">外部题库</div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error("Error loading stats:", error);
                    document.getElementById("statsContent").innerHTML = `
                        <div class="error-result">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载统计信息失败</p>
                        </div>
                    `;
                }
            }

            // 清除缓存
            document
                .getElementById("clearCacheBtn")
                .addEventListener("click", async function () {
                    const resultDiv = document.getElementById("cacheResult");
                    const button = this;

                    // 显示加载状态
                    button.disabled = true;
                    button.innerHTML =
                        '<i class="fas fa-spinner fa-spin"></i><span>清除中...</span>';

                    try {
                        const response = await fetch("/api/cache/clear", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        });

                        const result = await response.json();

                        if (result.success) {
                            resultDiv.innerHTML = `
                                <div class="success-message">
                                    <i class="fas fa-check-circle"></i>
                                    ${result.message}
                                </div>
                            `;
                            resultDiv.className = "result-message success";
                            // 重新加载统计信息
                            loadStats();
                        } else {
                            resultDiv.innerHTML = `
                                <div class="error-message">
                                    <i class="fas fa-times-circle"></i>
                                    ${result.message}
                                </div>
                            `;
                            resultDiv.className = "result-message error";
                        }
                    } catch (error) {
                        console.error("Error clearing cache:", error);
                        resultDiv.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-times-circle"></i>
                                清除缓存失败
                            </div>
                        `;
                        resultDiv.className = "result-message error";
                    } finally {
                        button.disabled = false;
                        button.innerHTML =
                            '<i class="fas fa-trash"></i><span>清除缓存</span>';
                        resultDiv.style.display = "block";
                    }
                });

            // 页面加载时获取统计信息
            loadStats();

            // 问答记录相关变量
            let currentPage = 1;
            const recordsPerPage = 10;

            // 加载问答记录
            async function loadQARecords(page = 1) {
                const recordsContent =
                    document.getElementById("qaRecordsContent");
                const prevBtn = document.getElementById("prevPageBtn");
                const nextBtn = document.getElementById("nextPageBtn");
                const pageInfo = document.getElementById("pageInfo");

                try {
                    const response = await fetch(
                        `/api/qa-records?page=${page}&per_page=${recordsPerPage}`
                    );
                    const result = await response.json();

                    if (result.success && result.records.length > 0) {
                        const recordsHtml = result.records
                            .map(
                                (record) => `
                            <div class="qa-record-item">
                                <div class="qa-record-question">
                                    <strong>问题：</strong>${record.question}
                                </div>
                                <div class="qa-record-answer">
                                    <strong>答案：</strong>${record.answer}
                                </div>
                                <div class="qa-record-meta">
                                    <span class="qa-record-timestamp">
                                        ${new Date(
                                            record.timestamp
                                        ).toLocaleString("zh-CN")}
                                    </span>
                                    <span class="qa-record-type">${
                                        record.question_type || "未知类型"
                                    }</span>
                                </div>
                            </div>
                        `
                            )
                            .join("");

                        recordsContent.innerHTML = recordsHtml;

                        // 更新分页信息
                        currentPage = page;
                        pageInfo.textContent = `第 ${page} 页`;

                        // 更新分页按钮状态
                        prevBtn.disabled = page <= 1;
                        nextBtn.disabled =
                            result.records.length < recordsPerPage;
                    } else {
                        recordsContent.innerHTML = `
                            <div class="no-records">
                                <i class="fas fa-inbox"></i>
                                <p>暂无问答记录</p>
                            </div>
                        `;
                        prevBtn.disabled = true;
                        nextBtn.disabled = true;
                    }
                } catch (error) {
                    console.error("Error loading QA records:", error);
                    recordsContent.innerHTML = `
                        <div class="error-result">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>加载问答记录失败</p>
                        </div>
                    `;
                }
            }

            // 刷新记录按钮事件
            document
                .getElementById("refreshRecordsBtn")
                .addEventListener("click", function () {
                    loadQARecords(currentPage);
                });

            // 清除记录按钮事件
            document
                .getElementById("clearRecordsBtn")
                .addEventListener("click", async function () {
                    const resultDiv =
                        document.getElementById("clearRecordsResult");
                    const button = this;

                    // 显示详细的确认对话框
                    const confirmed = confirm(
                        "⚠️ 警告：清除问答记录\n\n" +
                            "您即将删除所有问答记录，此操作将：\n" +
                            "• 删除所有历史问答数据\n" +
                            "• 无法恢复已删除的记录\n" +
                            "• 影响系统统计信息\n\n" +
                            "确定要继续吗？"
                    );

                    if (!confirmed) {
                        return;
                    }

                    // 再次确认
                    const doubleConfirmed =
                        confirm("最后确认：真的要清除所有问答记录吗？");
                    if (!doubleConfirmed) {
                        return;
                    }

                    // 显示加载状态
                    button.disabled = true;
                    button.innerHTML =
                        '<i class="fas fa-spinner fa-spin"></i><span>清除中...</span>';

                    try {
                        const response = await fetch("/api/qa-records/clear", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        });

                        const result = await response.json();

                        if (result.success) {
                            resultDiv.innerHTML = `
                                <div class="success-message">
                                    <i class="fas fa-check-circle"></i>
                                    ${result.message}
                                </div>
                            `;
                            resultDiv.className = "result-message success";
                            // 重新加载统计信息和问答记录
                            loadStats();
                            loadQARecords(1);
                        } else {
                            resultDiv.innerHTML = `
                                <div class="error-message">
                                    <i class="fas fa-times-circle"></i>
                                    ${result.message}
                                </div>
                            `;
                            resultDiv.className = "result-message error";
                        }
                    } catch (error) {
                        console.error("Error clearing QA records:", error);
                        resultDiv.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-times-circle"></i>
                                清除问答记录失败
                            </div>
                        `;
                        resultDiv.className = "result-message error";
                    } finally {
                        button.disabled = false;
                        button.innerHTML =
                            '<i class="fas fa-trash-alt"></i><span>清除记录</span>';
                        resultDiv.style.display = "block";
                    }
                });

            // 分页按钮事件
            document
                .getElementById("prevPageBtn")
                .addEventListener("click", function () {
                    if (currentPage > 1) {
                        loadQARecords(currentPage - 1);
                    }
                });

            document
                .getElementById("nextPageBtn")
                .addEventListener("click", function () {
                    loadQARecords(currentPage + 1);
                });

            // 页面加载时获取问答记录
            loadQARecords();
        </script>
    </body>
</html>
