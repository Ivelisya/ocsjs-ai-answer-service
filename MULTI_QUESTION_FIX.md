# 多子问题答案格式修复说明

## 问题描述

用户反馈处理 Short Answer 类型题目时出现错误。具体问题是：当题目包含多个编号的子问题时（如"1. 问题 1？ 2. 问题 2？"），期望答案格式为每行一个答案：

```
1.答案1
2.答案2
3.答案3
```

而不是用空格或其他分隔符连接。

## 用户的实际案例

```java
// LoginServlet.java 代码...
1. HttpSession session = req.getSession(); 这一行代码实现什么功能？
2. Cookie[] cookies = req.getCookies(); 这一行代码实现什么功能？
3. resp.addCookie(langCookie); 这一行代码实现什么功能？
4. resp.sendRedirect("cart.jsp"); 这一行代码实现什么功能？
5. 说说这段代码实现主要完成一个什么功能？
```

## 修复方案

### 1. 修改答案提取逻辑 (`utils.py`)

-   添加 `_is_multi_subquestion()` 函数检测多子问题
-   修改 `extract_answer()` 函数，当检测到多子问题时：
    -   将 AI 返回的`#`分隔答案转换为换行格式
    -   每个答案前自动添加序号 (`1.`, `2.`, `3.` 等)
    -   智能处理答案数量，避免因内容中的`#`符号导致错误分割
    -   **新增**：支持处理直接文本格式的 AI 回答（空格分隔）

### 2. 更新提示词模板 (`prompts.py`)

-   添加多子问题专用示例模板
-   在答案格式指南中明确说明多子问题的处理方式
-   指导 AI 对于多子问题仍使用`#`分隔，系统会自动转换格式

### 3. 增强模式检测

支持多种编号格式：

-   数字+点号：`1. 问题`
-   数字+括号：`1) 问题`
-   中文括号：`（1）问题`

## 修复效果

**修复前：**

```
获取当前HTTP会话对象，如果不存在则创建一个新的会话。 获取客户端随请求发送的所有Cookie。 将一个Cookie添加到HTTP响应中，使其发送给客户端。 将客户端重定向到指定的URL（"cart.jsp"）。 这段代码实现了一个简单的用户登录验证功能...
```

**修复后：**

```
1.获取当前HTTP会话对象，如果不存在则创建一个新的会话
2.获取客户端随请求发送的所有Cookie
3.将一个Cookie添加到HTTP响应中，使其发送给客户端
4.将客户端重定向到指定的URL（"cart.jsp"）
5.这段代码实现了一个简单的用户登录验证功能。成功登录后，它会创建用户会话，处理语言偏好Cookie，并将用户重定向到cart.jsp页面；登录失败则显示错误信息
```

## 兼容性保证

-   单一问题的填空题保持原有格式不变
-   其他题型（单选、多选、判断）不受影响
-   非编号的多空填空题仍使用`#`分隔符

## 测试覆盖

-   ✅ 多子问题检测准确性
-   ✅ 答案格式转换正确性
-   ✅ 单一问题兼容性
-   ✅ 复杂答案内容处理
-   ✅ 用户真实案例验证
-   ✅ 现有功能回归测试
-   ✅ **新增**：实际 AI 回答格式处理（空格分隔文本）

修复完成，用户现在可以获得期望的每行一个答案的格式。

## 最新修复情况

**问题根因**：用户遇到的实际 AI 回答是直接的文本格式（用空格分隔），而不是我们预期的`<answer>`标签格式或`#`分隔格式。

**最终解决方案**：在`extract_answer()`函数的`cleaned_response`处理部分添加了对直接文本格式的智能解析，能够：

1. 检测用句号+空格分隔的答案
2. 智能分割空格分隔的多个答案
3. 根据题目中的问题数量重新组织答案
4. 自动添加序号并格式化为换行输出

现在系统能够处理所有常见的 AI 回答格式，确保多子问题都能获得期望的换行分隔格式。
